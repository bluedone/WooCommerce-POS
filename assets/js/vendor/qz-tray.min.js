var qz=function(){function a(a,c){this.setPrinter=function(a){"string"==typeof a&&(a={name:a}),this.printer=a},this.getPrinter=function(){return this.printer},this.reconfigure=function(a){b.tools.extend(this.config,a)},this.getOptions=function(){return this.config},this.setPrinter(a),this.config=c}Array.isArray||(Array.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)});var b={DEBUG:!1,log:{trace:function(){b.DEBUG&&console.log.apply(console,arguments)},info:function(){console.info.apply(console,arguments)},warn:function(){b.DEBUG&&console.warn.apply(console,arguments)},error:function(){console.error.apply(console,arguments)}},streams:{serial:"SERIAL",usb:"USB",hid:"HID"},websocket:{connection:null,connectConfig:{host:["localhost","localhost.qz.io"],hostIndex:0,usingSecure:!0,protocol:{secure:"wss://",insecure:"ws://"},port:{secure:[8181,8282,8383,8484],insecure:[8182,8283,8384,8485],portIndex:0},keepAlive:60,retries:0,delay:0},setup:{findConnection:function(a,c,d){var e,f=function(){if(a.port.portIndex++,a.usingSecure&&a.port.portIndex>=a.port.secure.length||!a.usingSecure&&a.port.portIndex>=a.port.insecure.length){if(a.hostIndex>=a.host.length-1)return void d(new Error("Unable to establish connection with QZ"));a.hostIndex++,a.port.portIndex=0}b.websocket.setup.findConnection(a,c,d)};e=a.usingSecure?a.protocol.secure+a.host[a.hostIndex]+":"+a.port.secure[a.port.portIndex]:a.protocol.insecure+a.host[a.hostIndex]+":"+a.port.insecure[a.port.portIndex];try{b.log.trace("Attempting connection",e),b.websocket.connection=new b.tools.ws(e)}catch(a){return b.log.error(a),void f()}null!=b.websocket.connection?(b.websocket.connection.established=!1,b.websocket.connection.onopen=function(f){if(b.log.trace(f),b.log.info("Established connection with QZ Tray on "+e),b.websocket.setup.openConnection({resolve:c,reject:d}),a.keepAlive>0)var g=setInterval(function(){return qz.websocket.isActive()?void b.websocket.connection.send("ping"):void clearInterval(g)},1e3*a.keepAlive)},b.websocket.connection.onclose=function(){navigator.userAgent.indexOf("Safari")!=-1&&navigator.userAgent.indexOf("Chrome")==-1&&b.websocket.connection.onerror()},b.websocket.connection.onerror=function(a){b.log.trace(a),f()}):d(new Error("Unable to create a websocket connection"))},openConnection:function(a){function c(c){void 0===c&&(c=null),b.websocket.connection.sendData({certificate:c,promise:a})}b.websocket.connection.established=!0,b.websocket.connection.onclose=function(a){b.log.trace(a),b.log.info("Closed connection with QZ Tray"),void 0!=b.websocket.connection.promise&&b.websocket.connection.promise.resolve(),b.websocket.callClose(a),b.websocket.connection=null;for(var c in b.websocket.pendingCalls)b.websocket.pendingCalls.hasOwnProperty(c)&&b.websocket.pendingCalls[c].reject(new Error("Connection closed before response received"))},b.websocket.connection.onerror=function(a){b.websocket.callError(a)},b.websocket.connection.sendData=function(a){b.log.trace("Preparing object for websocket",a),void 0==a.timestamp&&(a.timestamp=Date.now()),void 0!=a.promise&&(a.uid=b.websocket.setup.newUID(),b.websocket.pendingCalls[a.uid]=a.promise);try{if(void 0!=a.call&&void 0==a.signature){var c={call:a.call,params:a.params,timestamp:a.timestamp};b.security.callSign(b.tools.hash(b.tools.stringify(c))).then(function(c){b.log.trace("Signature for call",c),a.signature=c,b.signContent=void 0,b.websocket.connection.send(b.tools.stringify(a))})}else b.log.trace("Signature for call",a.signature),b.websocket.connection.send(b.tools.stringify(a))}catch(c){b.log.error(c),void 0!=a.promise&&(a.promise.reject(c),delete b.websocket.pendingCalls[a.uid])}},b.websocket.connection.onmessage=function(a){var c=JSON.parse(a.data);if(null!=c.uid){b.log.trace("Received response from websocket",c);var d=b.websocket.pendingCalls[c.uid];void 0==d?b.log.warn("No promise found for returned response"):void 0!=c.error?d.reject(new Error(c.error)):d.resolve(c.result),delete b.websocket.pendingCalls[c.uid]}else if(null==c.type)b.websocket.connection.close(4003,"Connected to incompatible QZ Tray version");else switch(c.type){case b.streams.serial:c.event||(c.event=JSON.stringify({portName:c.key,output:c.data})),b.serial.callSerial(JSON.parse(c.event));break;case b.streams.usb:c.event||(c.event=JSON.stringify({vendorId:c.key[0],productId:c.key[1],output:c.data})),b.usb.callUsb(JSON.parse(c.event));break;case b.streams.hid:b.hid.callHid(JSON.parse(c.event));break;default:b.log.warn("Cannot determine stream type for callback",c)}},b.security.callCert().then(c).catch(c)},newUID:function(){var a=6;return(new Array(a+1).join("0")+(Math.random()*Math.pow(36,a)<<0).toString(36)).slice(-a)}},dataPromise:function(a,c,d,e){return b.tools.promise(function(f,g){var h={call:a,promise:{resolve:f,reject:g},params:c,signature:d,timestamp:e};b.websocket.connection.sendData(h)})},pendingCalls:{},errorCallbacks:[],callError:function(a){if(Array.isArray(b.websocket.errorCallbacks))for(var c=0;c<b.websocket.errorCallbacks.length;c++)b.websocket.errorCallbacks[c](a);else b.websocket.errorCallbacks(a)},closedCallbacks:[],callClose:function(a){if(Array.isArray(b.websocket.closedCallbacks))for(var c=0;c<b.websocket.closedCallbacks.length;c++)b.websocket.closedCallbacks[c](a);else b.websocket.closedCallbacks(a)}},printing:{defaultConfig:{colorType:"color",copies:1,density:0,duplex:!1,fallbackDensity:600,interpolation:"bicubic",jobName:null,margins:0,orientation:null,paperThickness:null,printerTray:null,rasterize:!0,rotation:0,scaleContent:!0,size:null,units:"in",altPrinting:!1,encoding:null,endOfDoc:null,perSpool:1}},serial:{serialCallbacks:[],callSerial:function(a){if(Array.isArray(b.serial.serialCallbacks))for(var c=0;c<b.serial.serialCallbacks.length;c++)b.serial.serialCallbacks[c](a);else b.serial.serialCallbacks(a)}},usb:{usbCallbacks:[],callUsb:function(a){if(Array.isArray(b.usb.usbCallbacks))for(var c=0;c<b.usb.usbCallbacks.length;c++)b.usb.usbCallbacks[c](a);else b.usb.usbCallbacks(a)}},hid:{hidCallbacks:[],callHid:function(a){if(Array.isArray(b.hid.hidCallbacks))for(var c=0;c<b.hid.hidCallbacks.length;c++)b.hid.hidCallbacks[c](a);else b.hid.hidCallbacks(a)}},security:{certPromise:function(a,b){b()},callCert:function(){return b.tools.promise(b.security.certPromise)},signaturePromise:function(){return function(a){a()}},callSign:function(a){return b.tools.promise(b.security.signaturePromise(a))}},tools:{promise:function(a){return new Promise(a)},stringify:function(a){var b=Array.prototype.toJSON;delete Array.prototype.toJSON;var c=JSON.stringify(a);return Array.prototype.toJSON=b,c},hash:"undefined"!=typeof Sha256?Sha256.hash:null,ws:"undefined"!=typeof WebSocket?WebSocket:null,absolute:function(a){if(document&&"function"==typeof document.createElement){var b=document.createElement("a");return b.href=a,b.href}return a},extend:function(a){"object"!=typeof a&&(a={});for(var c=1;c<arguments.length;c++){var d=arguments[c];if(d)for(var e in d)if(d.hasOwnProperty(e)){if(a===d[e])continue;if(d[e]&&d[e].constructor&&d[e].constructor===Object){var f;f=Array.isArray(d[e])?a[e]||[]:a[e]||{},a[e]=b.tools.extend(f,d[e])}else void 0!==d[e]&&(a[e]=d[e])}}return a}}};return a.prototype.print=function(a,b,c){qz.print(this,a,b,c)},{websocket:{isActive:function(){return null!=b.websocket.connection&&b.websocket.connection.established},connect:function(a){return b.tools.promise(function(c,d){if(qz.websocket.isActive())return void d(new Error("An open connection with QZ Tray already exists"));if(null!=b.websocket.connection)return void d(new Error("The current connection attempt has not returned yet"));if(!b.tools.ws)return void d(new Error("WebSocket not supported by this browser"));if(!b.tools.ws.CLOSED||2==b.tools.ws.CLOSED)return void d(new Error("Unsupported WebSocket version detected: HyBi-00/Hixie-76"));void 0==a&&(a={}),"undefined"!=typeof location&&"https:"===location.protocol||"undefined"==typeof a.usingSecure&&(b.log.trace("Disabling secure ports due to insecure page"),a.usingSecure=!1),"undefined"==typeof a.host||Array.isArray(a.host)||(a.host=[a.host]);var e=function(f){var g=function(){a&&f<a.retries?e(f+1):(b.websocket.connection=null,d.apply(null,arguments))},h=function(){var d=b.tools.extend({},b.websocket.connectConfig,a);b.websocket.setup.findConnection(d,c,g)};0==f?h():setTimeout(h,1e3*a.delay)};e(0)})},disconnect:function(){return b.tools.promise(function(a,c){qz.websocket.isActive()?(b.websocket.connection.close(),b.websocket.connection.promise={resolve:a,reject:c}):c(new Error("No open connection with QZ Tray"))})},setErrorCallbacks:function(a){b.websocket.errorCallbacks=a},setClosedCallbacks:function(a){b.websocket.closedCallbacks=a},getNetworkInfo:function(){return b.websocket.dataPromise("websocket.getNetworkInfo")}},printers:{getDefault:function(){return b.websocket.dataPromise("printers.getDefault")},find:function(a){return b.websocket.dataPromise("printers.find",{query:a})}},configs:{setDefaults:function(a){b.tools.extend(b.printing.defaultConfig,a)},create:function(c,d){var e=b.tools.extend({},b.printing.defaultConfig,d);return new a(c,e)}},print:function(a,c,d,e){for(var f=0;f<c.length;f++)c[f].constructor===Object&&(!c[f].format&&c[f].type&&"RAW"!==c[f].type.toUpperCase()||c[f].format&&("FILE"===c[f].format.toUpperCase()||"IMAGE"===c[f].format.toUpperCase()||"XML"===c[f].format.toUpperCase()))&&(c[f].data=b.tools.absolute(c[f].data));var g={printer:a.getPrinter(),options:a.getOptions(),data:c};return b.websocket.dataPromise("print",g,d,e)},serial:{findPorts:function(){return b.websocket.dataPromise("serial.findPorts")},setSerialCallbacks:function(a){b.serial.serialCallbacks=a},openPort:function(a,c){var d={port:a,bounds:c};return b.websocket.dataPromise("serial.openPort",d)},sendData:function(a,c,d){var e={port:a,data:c,properties:d};return b.websocket.dataPromise("serial.sendData",e)},closePort:function(a){return b.websocket.dataPromise("serial.closePort",{port:a})}},usb:{listDevices:function(a){return b.websocket.dataPromise("usb.listDevices",{includeHubs:a})},listInterfaces:function(a,c){var d={vendorId:a,productId:c};return b.websocket.dataPromise("usb.listInterfaces",d)},listEndpoints:function(a,c,d){var e={vendorId:a,productId:c,interface:d};return b.websocket.dataPromise("usb.listEndpoints",e)},setUsbCallbacks:function(a){b.usb.usbCallbacks=a},claimDevice:function(a,c,d){var e={vendorId:a,productId:c,interface:d};return b.websocket.dataPromise("usb.claimDevice",e)},sendData:function(a,c,d,e){var f={vendorId:a,productId:c,endpoint:d,data:e};return b.websocket.dataPromise("usb.sendData",f)},readData:function(a,c,d,e){var f={vendorId:a,productId:c,endpoint:d,responseSize:e};return b.websocket.dataPromise("usb.readData",f)},openStream:function(a,c,d,e,f){var g={vendorId:a,productId:c,endpoint:d,responseSize:e,interval:f};return b.websocket.dataPromise("usb.openStream",g)},closeStream:function(a,c,d){var e={vendorId:a,productId:c,endpoint:d};return b.websocket.dataPromise("usb.closeStream",e)},releaseDevice:function(a,c){var d={vendorId:a,productId:c};return b.websocket.dataPromise("usb.releaseDevice",d)}},hid:{listDevices:function(){return b.websocket.dataPromise("hid.listDevices")},startListening:function(){return b.websocket.dataPromise("hid.startListening")},stopListening:function(){return b.websocket.dataPromise("hid.stopListening")},setHidCallbacks:function(a){b.hid.hidCallbacks=a},claimDevice:function(a,c){var d={vendorId:a,productId:c};return b.websocket.dataPromise("hid.claimDevice",d)},sendData:function(a,c,d,e){var f={vendorId:a,productId:c,endpoint:e,data:d};return b.websocket.dataPromise("hid.sendData",f)},readData:function(a,c,d){var e={vendorId:a,productId:c,responseSize:d};return b.websocket.dataPromise("hid.readData",e)},openStream:function(a,c,d,e){var f={vendorId:a,productId:c,responseSize:d,interval:e};return b.websocket.dataPromise("hid.openStream",f)},closeStream:function(a,c){var d={vendorId:a,productId:c};return b.websocket.dataPromise("hid.closeStream",d)},releaseDevice:function(a,c){var d={vendorId:a,productId:c};return b.websocket.dataPromise("hid.releaseDevice",d)}},security:{setCertificatePromise:function(a){b.security.certPromise=a},setSignaturePromise:function(a){b.security.signaturePromise=a}},api:{showDebug:function(a){b.DEBUG=a},getVersion:function(){return b.websocket.dataPromise("getVersion")},setPromiseType:function(a){b.tools.promise=a},setSha256Type:function(a){b.tools.hash=a},setWebSocketType:function(a){b.tools.ws=a}}}}(),Sha256={};Sha256.hash=function(a){a=a.utf8Encode();var b=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],c=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225];a+=String.fromCharCode(128);for(var d=a.length/4+2,e=Math.ceil(d/16),f=new Array(e),g=0;e>g;g++){f[g]=new Array(16);for(var h=0;16>h;h++)f[g][h]=a.charCodeAt(64*g+4*h)<<24|a.charCodeAt(64*g+4*h+1)<<16|a.charCodeAt(64*g+4*h+2)<<8|a.charCodeAt(64*g+4*h+3)}f[e-1][14]=8*(a.length-1)/Math.pow(2,32),f[e-1][14]=Math.floor(f[e-1][14]),f[e-1][15]=8*(a.length-1)&4294967295;for(var i,j,k,l,m,n,o,p,q=new Array(64),g=0;e>g;g++){for(var r=0;16>r;r++)q[r]=f[g][r];for(var r=16;64>r;r++)q[r]=Sha256.σ1(q[r-2])+q[r-7]+Sha256.σ0(q[r-15])+q[r-16]&4294967295;i=c[0],j=c[1],k=c[2],l=c[3],m=c[4],n=c[5],o=c[6],p=c[7];for(var r=0;64>r;r++){var s=p+Sha256.Σ1(m)+Sha256.Ch(m,n,o)+b[r]+q[r],t=Sha256.Σ0(i)+Sha256.Maj(i,j,k);p=o,o=n,n=m,m=l+s&4294967295,l=k,k=j,j=i,i=s+t&4294967295}c[0]=c[0]+i&4294967295,c[1]=c[1]+j&4294967295,c[2]=c[2]+k&4294967295,c[3]=c[3]+l&4294967295,c[4]=c[4]+m&4294967295,c[5]=c[5]+n&4294967295,c[6]=c[6]+o&4294967295,c[7]=c[7]+p&4294967295}return Sha256.toHexStr(c[0])+Sha256.toHexStr(c[1])+Sha256.toHexStr(c[2])+Sha256.toHexStr(c[3])+Sha256.toHexStr(c[4])+Sha256.toHexStr(c[5])+Sha256.toHexStr(c[6])+Sha256.toHexStr(c[7])},Sha256.ROTR=function(a,b){return b>>>a|b<<32-a},Sha256.Σ0=function(a){return Sha256.ROTR(2,a)^Sha256.ROTR(13,a)^Sha256.ROTR(22,a)},Sha256.Σ1=function(a){return Sha256.ROTR(6,a)^Sha256.ROTR(11,a)^Sha256.ROTR(25,a)},Sha256.σ0=function(a){return Sha256.ROTR(7,a)^Sha256.ROTR(18,a)^a>>>3},Sha256.σ1=function(a){return Sha256.ROTR(17,a)^Sha256.ROTR(19,a)^a>>>10},Sha256.Ch=function(a,b,c){return a&b^~a&c},Sha256.Maj=function(a,b,c){return a&b^a&c^b&c},Sha256.toHexStr=function(a){for(var b,c="",d=7;d>=0;d--)b=a>>>4*d&15,c+=b.toString(16);return c},"undefined"==typeof String.prototype.utf8Encode&&(String.prototype.utf8Encode=function(){return unescape(encodeURIComponent(this))}),"undefined"==typeof String.prototype.utf8Decode&&(String.prototype.utf8Decode=function(){try{return decodeURIComponent(escape(this))}catch(a){return this}}),"undefined"!=typeof module&&module.exports&&(module.exports=Sha256),"function"==typeof define&&define.amd&&define([],function(){return Sha256}),qz.api.setSha256Type(Sha256.hash),qz.api.showDebug(!0),window.qz=qz;