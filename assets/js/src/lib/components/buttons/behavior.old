var Behavior = require('lib/config/behavior');
var POS = require('lib/utilities/global');
var bb = require('backbone');

var Buttons = Behavior.extend({

  initialize: function(options){
    options = options || {};
    if(options.modal){
      this.modalSetup();
    }
  },

  ui: {
    save : '*[data-action="save"]'
  },

  triggers: {
    'click @ui.save': 'action:save'
  },

  modelEvents: {
    'update:start': 'saving',
    'update:stop' : 'saved'
  },

  saving: function() {
    this.ui.save
      .prop( 'disabled', true )
      .siblings( 'p.response' )
      .html( '<i class="spinner"></i>' );
  },

  saved: function() {
    var response = this.view.model.get('response');
    var success = response.result === 'success' ? 'yes' : 'no';
    this.ui.save
      .prop( 'disabled', false)
      .siblings( 'p.response' )
      .html( '' +
      '<i class="dashicons dashicons-' + success + '"></i>' +
      response.notice
    );

    this.view.model.unset( 'response', { silent: true } );
  },

  /**
   * Modal setup
   *
   * modal buttons are behaviors on the modal view
   * but need to share events with the modal content view
   */
  modalSetup: function(){
    this.listenTo(this.view.content, {
      'before:show' : this.beforeModalContentShow,
      'before:empty': this.beforeModalContentEmpty
    }, this);
  },

  beforeModalContentShow: function(view){
    this.view.model = view.model;
    bb.Marionette.bindEntityEvents(
      this, this.view.model, this.modelEvents
    );
  },

  beforeModalContentEmpty: function(){
    this.ui.save.siblings('p.response').html('');
  }

});

module.exports = Buttons;
POS.attach('Components.Buttons.Behavior', Buttons);