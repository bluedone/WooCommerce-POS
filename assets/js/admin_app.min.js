_.extend(Marionette.Application.prototype,{debugLog:function(a,b){_.isUndefined(this.debug)&&(this.debug=localStorage.getItem("wc_pos_debug")?!0:!1,Backbone.Radio.DEBUG=this.debug,console.info("Debugging is "+(this.debug?"on":"off")+", visit http://woopos.com.au/docs/debugging")),this.debug&&console[a](b)},navigate:function(a,b){b||(b={}),Backbone.history.navigate(a,b)},getCurrentRoute:function(){var a=Backbone.history.fragment;return _.isEmpty(a)?null:a},startHistory:function(){return Backbone.history?Backbone.history.start():void 0},register:function(a,b){return this._registry||(this._registry={}),this._registry[b]=a},unregister:function(a,b){return delete this._registry[b]},resetRegistry:function(){var a,b,c,d,e;d=this.getRegistrySize(),e=this._registry;for(b in e)a=e[b],a.region.close();return c="There were "+d+" controllers in the registry, there are now "+this.getRegistrySize(),this.getRegistrySize()>0?console.warn(c,this._registry):console.log(c)},getRegistrySize:function(){return _.size(this._registry)}});var POS=new Marionette.Application;Marionette.Behaviors.getBehaviorClass=function(a,b){return POS.Components[b].Behavior},POS.channel.reply("default:region",function(){return POS.mainRegion}),POS.channel.comply("register:instance",function(a,b){return POS.register(a,b)}),POS.channel.comply("unregister:instance",function(a,b){return POS.unregister(a,b)}),POS.module("Entities",function(a){a.channel=Backbone.Radio.channel("entities")}),POS.addInitializer(function(a){POS.ajaxurl=ajaxurl;var b=["nonce"];_(b).each(function(b){_.isUndefined(a[b])||(POS[b]=a[b])}),"settings"===a.page&&POS.addRegions({modalRegion:"#wc-pos-modal"})}),POS.on("start",function(a){POS.debugLog("log","POS Admin App started"),POS.startHistory(),"settings"===a.page&&POS.module("SettingsApp").start()}),POS.Controller={},POS.Controller.Base=Marionette.Controller.extend({constructor:function(a){return a||(a={}),this.region=a.region||POS.channel.request("default:region"),this._instance_id=_.uniqueId("controller"),POS.channel.command("register:instance",this,this._instance_id),Marionette.Controller.prototype.constructor.apply(this,arguments)},destroy:function(){return POS.channel.command("unregister:instance",this,this._instance_id),Marionette.Controller.prototype.destroy.apply(this,arguments)},show:function(a,b){b||(b={}),_.defaults(b,{loading:!1,region:this.region}),this._setMainView(a),this._manageView(a,b)},_setMainView:function(a){this._mainView||(this._mainView=a,this.listenTo(a,"destroy",this.destroy))},_manageView:function(a,b){return b.loading?POS.Components.Loading.channel.command("show:loading",a,b):void b.region.show(a)}}),POS.module("Entities.Settings",function(a,b,c,d,e,f){b.addInitializer(function(b){a.hotkeys=new a.Usermeta(b.hotkeys,{id:"hotkeys"})}),a.Usermeta=c.Collection.extend({initialize:function(a,b){this.id=b.id},save:function(){var a=this.toJSON(),c={id:this.id,action:"wc_pos_user_settings",security:b.nonce,data:a[0]};e.post(b.ajaxurl,c,function(a){console.log(a)})}}),a.Option=c.Model.extend({initialize:function(){this.url=b.ajaxurl,this._saving=!1},sync:function(a,d,e){var g="id="+d.get("id"),h="action=wc_pos_admin_settings",i="security="+b.nonce;e.emulateHTTP=!0,e.url=d.url+"?"+h+"&"+g+"&"+i;var j={beforeSend:function(){this.trigger("update:start"),this._saving=!0},complete:function(){this.trigger("update:stop"),this._saving=!1}};return this._saving||"update"!==a||f.defaults(e,{beforeSend:f.bind(j.beforeSend,d),complete:f.bind(j.complete,d)}),c.sync(a,d,e)}}),a.Options=c.Collection.extend({model:a.Option}),b.Entities.channel.reply("hotkeys",function(){return a.hotkeys}),b.Entities.channel.reply("options",function(b){return new a.Options([],b)})}),POS.module("Components.Tooltip",function(a,b,c,d,e,f){a.Behavior=d.Behavior.extend({initialize:function(a){this.options=f.defaults(a,{})},ui:{tooltip:'*[data-toggle="tooltip"]'},onRender:function(){this.ui.tooltip.tooltip(this.options)},onBeforeDestroy:function(){this.ui.tooltip.tooltip("destroy")}})}),POS.module("Components.Select2",function(a,b,c,d,e,f){a.Behavior=d.Behavior.extend({initialize:function(a){this.options=f.defaults(a,{minimumInputLength:2})},ui:{select:".select2"},onShow:function(){this.ui.select.select2(this.options)},onBeforeDestroy:function(){this.ui.select.select2("destroy")}})}),POS.module("Components.Sortable",function(a,b,c,d,e,f){a.Behavior=d.Behavior.extend({initialize:function(a){this.options=f.defaults(a,{items:"tr",cursor:"move",axis:"y",handle:"td",scrollSensitivity:40,helper:function(a,b){return b.children().each(function(){e(this).width(e(this).width())}),b},start:function(a,b){b.item.css("background-color","#f6f6f6")},stop:function(a,b){b.item.removeAttr("style"),e("input.gateway_order",this).each(function(a){e(this).val(a)})}})},ui:{sortable:".sortable"},onShow:function(){if(this.ui.sortable.length>0){var a=this.ui.sortable,b=a.find("tbody tr").get();a.append(b.sort(function(a,b){return parseInt(e(a).find("input.gateway_order").val(),10)-parseInt(e(b).find("input.gateway_order").val(),10)})),a.sortable(this.options)}}})}),POS.module("Components.Modal",function(a,b,c,d,e,f){b.addInitializer(function(){new a.Controller({container:b.modalRegion})}),a.channel=c.Radio.channel("modal"),a.Controller=d.Controller.extend({initialize:function(b){this.container=b.container,this.view=new a.View,this.container.show(this.view),f.bindAll(this,"openModal","closeModal"),a.channel.comply("open",this.openModal),a.channel.comply("close",this.closeModal)},openModal:function(a){this.view.openModal(a)},closeModal:function(a){this.view.closeModal(a)}})}),POS.module("Components.Modal",function(a,b,c,d,e,f){a.View=d.LayoutView.extend({template:f.template('<div class="modal-dialog"><div class="modal-content"></div></div>'),className:"modal",attributes:{tabindex:-1,role:"dialog"},regions:{content:".modal-content"},initialize:function(){this.$el.modal({show:!1})},triggers:{"show.bs.modal":{preventDefault:!1,event:"show:modal"},"shown.bs.modal":{preventDefault:!1,event:"after:show:modal"},"hide.bs.modal":{preventDefault:!1,event:"hide:modal"},"hidden.bs.modal":{preventDefault:!1,event:"after:hide:modal"}},openModal:function(a){this.once("after:show:modal",a.callback),this.setupModal(a),this.$el.modal("show")},closeModal:function(a){this.once("after:hide:modal",a.callback),this.once("after:hide:modal",this.teardownModal),this.$el.modal("hide")},setupModal:function(a){this.isShown&&this.teardownModal(),this.content.show(a.view),this.isShown=!0},teardownModal:function(){this.isShown&&(this.content.empty(),this.isShown=!1)}})}),POS.module("Components.Modal",function(a,b,c,d){a.Behavior=d.Behavior.extend({initialize:function(){this.listenToOnce(this.view,"modal:open",this.openModal)},openModal:function(b){a.channel.command("open",{view:this.view,callback:b}),this.listenToOnce(this.view,"modal:close",this.closeModal)},closeModal:function(b){a.channel.command("close",{callback:b})}})}),POS.module("Components.Loading",function(a,b,c,d,e,f){a.channel=c.Radio.channel("loading"),a.channel.comply("show:loading",function(b,c){return new a.Controller({view:b,region:c.region,config:c.loading})}),a.Controller=b.Controller.Base.extend({initialize:function(b){var c=b.view,d=b.config;switch(d=f.isBoolean(d)?{}:d,f.defaults(d,{loadingType:"spinner"}),d.loadingType){case"spinner":var e=new a.Spinner;this.show(e);break;case"opacity":this.region.currentView.$el.css({opacity:.5});break;default:throw new Error("Invalid loadingType")}this.showRealView(c,e,d)},showRealView:function(a,b,c){var d=this,g=c.entities;f.isArray(g)||(g=[c.entities]),e.when.apply(e,g).always(function(){switch(c.loadingType){case"spinner":if(d.region.currentView!==b)return a.close();break;case"opacity":d.region.currentView.$el.removeAttr("style")}d.show(a)})}})}),POS.module("Components.Loading",function(a,b,c,d){a.Spinner=d.ItemView.extend({template:!1,className:"loading"})}),POS.module("SettingsApp",function(a,b){a.startWithParent=!1,a.onStart=function(){b.debugLog("log","POS Settings Module started");var c=b.getCurrentRoute()||"general";new a.Show.Controller({tab:c})}}),POS.module("SettingsApp.Show",function(a,b,c,d,e,f){a.Controller=b.Controller.Base.extend({initialize:function(a){this.settingsCollection=b.Entities.channel.request("options"),this.settingsRegion=new d.Region({el:"#wc-pos-settings"}),this._showTabs(a),this._showSettings(a)},_showTabs:function(c){var d=new a.Tabs(c);this.listenTo(d,"settings:tab:clicked",function(a){b.navigate(a),this._showSettings({tab:a})},this)},_showSettings:function(c){var d=this.settingsCollection.add({id:c.tab}),e=new a.Settings({collection:this.settingsCollection,model:d});this.listenTo(e,"settings:form:submit",function(a){this._saveSettings(a)}),f.isEmpty(d.previousAttributes())&&"tools"!==c.tab?b.Components.Loading.channel.command("show:loading",e,{region:this.settingsRegion,loading:{entities:d.fetch()}}):this.settingsRegion.show(e)},_saveSettings:function(a){a.save()}})}),POS.module("SettingsApp.Show",function(a,b,c,d,e,f){a.Tabs=d.ItemView.extend({el:"#wc-pos-settings-tabs",initialize:function(a){this.$('a[data-tab="'+a.tab+'"]').addClass("nav-tab-active")},events:{"click a":"onTabClicked"},onTabClicked:function(a){a.preventDefault();var b=e(a.target);b.hasClass("nav-tab-active")||(this.trigger("settings:tab:clicked",b.data("tab")),b.addClass("nav-tab-active").siblings("a.nav-tab-active").removeClass("nav-tab-active"))}}),a.Settings=d.ItemView.extend({tagName:"form",initialize:function(){this.template=f.template(e("#tmpl-wc-pos-settings-"+this.model.id).html()),this.listenTo(this.model,"update:start",this.saving),this.listenTo(this.model,"update:stop",this.saved)},ui:{submit:'input[type="submit"]',id:'input[name="id"]'},events:{"click @ui.submit":"onSubmit","mouseenter a.wc-pos-modal":"proLoadSettings","click a.wc-pos-modal":"openModal","click a.action-translation":"translationUpdate"},behaviors:{Select2:{},Tooltip:{},Sortable:{}},onBeforeShow:function(){c.Syphon.deserialize(this,this.model.toJSON())},onBeforeDestroy:function(){this.storeState()},onSubmit:function(a){a.preventDefault(),this.storeState().save()},storeState:function(){var a=c.Syphon.serialize(this);return this.model.set(a)},saving:function(){console.log(this.ui.submit),this.ui.submit.prop("disabled",!0).next("p.response").html('<i class="spinner"></i>')},saved:function(){var a=this.model.get("response"),b="success"===a.result?"yes":"no";this.ui.submit.prop("disabled",!1).next("p.response").html('<i class="dashicons dashicons-'+b+'"></i>'+a.notice),this.model.unset("response",{silent:!0})},proLoadSettings:function(a){var b="gateway_"+e(a.target).data("gateway");if(f.isUndefined(this.collection.get(b))){var c=this.collection.add({id:b,security:this.model.get("security"),title:"Loading ..."});c.fetch()}},openModal:function(b){b.preventDefault();var c="gateway_"+e(b.target).data("gateway");new a.GatewaySettingsModal({model:this.collection.get(c)})},translationUpdate:function(b){b.preventDefault();var d=e(b.target).parent("td").prev("th").html();new a.TranslationUpdateModal({model:new c.Model({title:d})})}}),a.GatewaySettingsModal=d.ItemView.extend({template:f.template(e("#tmpl-gateway-settings-modal").html()),behaviors:{Modal:{},Tooltip:{}},initialize:function(){this.trigger("modal:open"),this.listenTo(this.model,"change",this.render)},events:{"click .save":"save","click .close":"cancel"},onBeforeShow:function(){c.Syphon.deserialize(this,this.model.toJSON())},save:function(){var a=c.Syphon.serialize(this);this.model.set(a),this.model.save()},cancel:function(){this.trigger("modal:close")}}),a.TranslationUpdateModal=d.ItemView.extend({template:f.template(e("#tmpl-translation-update-modal").html()),behaviors:{Modal:{}},initialize:function(){this.trigger("modal:open"),this.initUpdate()},events:{"click .close":"cancel"},cancel:function(){this.trigger("modal:close")},initUpdate:function(){var a=this,c=new EventSource(b.ajaxurl+"?action=wc_pos_update_translations&security="+b.nonce);c.onmessage=function(b){"complete"===b.data?(this.close(),a.$(".modal-body .spinner").hide(),a.$(".modal-footer").show()):a.$(".modal-body .spinner").before("<p>"+b.data+"</p>")}}})});
//# sourceMappingURL=maps/admin_app.map