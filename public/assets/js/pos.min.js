!function(a){"use strict";if(a("#filter input[type=search]").focus(),!Modernizr.indexeddb&&!Modernizr.websqldatabase){var b=a('<div class="modal fade"><div class="modal-dialog"><div class="modal-content">Hi!</div></div></div>');a.get(pos_cart_params.ajax_url,{action:"pos_get_modal",template:"browser-support"}).done(function(a){b.modal("show").find(".modal-content").html(a)})}}(jQuery),function(a){"use strict";function b(){a("#pagination").addClass("working");var b=!1,e=!1;g().then(function(a){return a.length>0?h(a):void 0}).then(function(){b=!0,i(b,e)});var f=m(l("last_update"));c(f).then(function(a){if(a>0){var b=100>a?a:100;return d(a,b,f)}}).then(function(){e=!0,i(b,e)})}function c(b){return b="undefined"!=typeof b?b:null,a.getJSON("/wc-api/v1/products/count",{"filter[updated_at_min]":b}).then(function(a){return console.log(a.count+" products need to be updated"),a.count},function(a,b,c){console.log("error "+b),console.log("incoming Text "+a.responseText),alert(c)})}function d(b,c,d){b="undefined"!=typeof b?b:10,c="undefined"!=typeof c?c:10,d="undefined"!=typeof d?d:null;for(var f=[],g=0;b>g;g+=c)f.push(e(c,g,d));return console.log(f.length+" ajax calls queued"),a.when.apply(a,f).always(function(){console.log("All products retrieved and saved")})}function e(b,c,d){return console.log("getting "+b+" products, offset by "+c),b="undefined"!=typeof b?b:10,c="undefined"!=typeof c?c:0,d="undefined"!=typeof d?d:null,a.getJSON("/wc-api/v1/products/",{"filter[limit]":b,"filter[offset]":c,"filter[updated_at_min]":d}).then(function(a){f(a)},function(a,b,c){alert(c)})}function f(a){console.log("saving "+a.products.length+" products"),_.each(a.products,function(a){q.fullCollection.create(a,{merge:!0,success:function(a,b){console.log("saved: "+b.title)},error:function(a,b){console.log("error saving model: "+b.title)}})})}function g(){return a.getJSON(pos_cart_params.ajax_url,{action:"pos_get_product_ids"}).then(function(a){if(a instanceof Array){for(var b=q.fullCollection.models,c=[],d=0;d<b.length;d++)c.push(b[d].id);var e=_.difference(c,a);return console.log(e.length+" products need to be deleted"),e}console.log("server response is no good")},function(a,b,c){console.log("error "+b),console.log("incoming Text "+a.responseText),alert(c)})}function h(a){if(a instanceof Array){for(var b=0;b<a.length;b++){{var c=q.fullCollection.get(a[b]);c.destroy()}q.remove(c)}console.log(b+" products removed")}}function i(b,c){b&&c&&(console.log("sync is done! "),k("last_update",Date.now()),v.render(),a("#pagination").removeClass("working"))}function j(a){try{q.sync("closeall");var b=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,c=b.deleteDatabase(a.id);c.onsuccess=function(b){b.result;console.log("indexedDB: "+a.id+" deleted")},c.onerror=function(a){console.error("indexedDB.delete Error: "+a.message)},c.onblocked=function(a){console.error("indexedDB.delete Error: "+a.message)}}catch(d){console.error("Error: "+d.message)}}function k(a,b){return Modernizr.localstorage?(localStorage.setItem("posMeta-"+a,b),console.log("saved "+a+": "+b),!0):!1}function l(a){if(!Modernizr.localstorage)return!1;var b=localStorage.getItem("posMeta-"+a);return b}function m(a){var b=new Date(+a);if(b.getTime()>0){var c=new Date(b).getFullYear(),d=new Date(b).getMonth()+1,e=new Date(b).getDate();return 10>d&&(d="0"+d),10>e&&(e="0"+e),c+"-"+d+"-"+e}return null}var n={id:"productsDB",description:"Products database",migrations:[{version:"1.0",migrate:function(a,b){var c;a.db.objectStoreNames.contains("products")||(c=a.db.createObjectStore("products",{keyPath:"id"})),c=a.objectStore("products"),c.createIndex("titleIndex","title",{unique:!1}),b()}}]},o=Backbone.Model.extend({database:n,storeName:"products",initialize:function(){this.on("all",function(a){console.log(this.get("title")+" event: "+a)})}}),p=Backbone.PageableCollection.extend({database:n,storeName:"products",model:o,mode:"client",state:{pageSize:5,totalRecords:null,sortKey:"updated_at",order:1},initialize:function(){this.on("all",function(a){console.log("Product Collection event: "+a)})}}),q=new p,r=Backbone.View.extend({tagName:"tr",model:new o,template:_.template(a("#tmpl-product").html()),events:{"click a.add-to-cart":"addToCart"},initialize:function(){this.model.on("all",function(a){console.log("Product View event: "+a)})},render:function(){var a=this.model.toJSON();return this.$el.html(this.template(a)),this},addToCart:function(a){a.preventDefault(),mediator.publish("addToCart",this.model)}}),s=Backbone.View.extend({el:a("#product-list"),model:q,elEmpty:a("#product-list").contents().clone(),initialize:function(){this.model.on("all",function(a){console.log("Product List event: "+a)}),this.model.on("all",this.render,this),q.fetch().done(function(){console.log("init collection with "+q.length+" products from indexedDB")}),b()},render:function(){console.log("render the products"),0===q.length?this.emptyMessage():this.$el.removeClass("empty").html(""),q.each(function(a){var b=new r({model:a});this.$el.append(b.render().el)},this)},emptyMessage:function(){this.$el.addClass("empty").html(this.elEmpty)}}),t=(new s,Backbone.View.extend({el:a("#filter"),collection:q,fields:["title"],events:{"keydown input[type=search]":"search",submit:"search","click a.clear":"clear"},wait:149,initialize:function(){this._debounceMethods(["search","clear"]);var a=this.collection=this.collection.fullCollection||this.collection,b=this.shadowCollection=a.clone();this.listenTo(a,"add",function(a,c,d){b.add(a,d)}),this.listenTo(a,"remove",function(a,c,d){b.remove(a,d)}),this.listenTo(a,"sort",function(a){this.searchBox().val()||b.reset(a.models)}),this.listenTo(a,"reset",function(a,c){c=_.extend({reindex:!0},c||{}),c.reindex&&null==c.from&&null==c.to&&b.reset(a.models)})},_debounceMethods:function(a){_.isString(a)&&(a=[a]),this.undelegateEvents();for(var b=0,c=a.length;c>b;b++){var d=a[b],e=this[d];this[d]=_.debounce(e,this.wait)}this.delegateEvents()},makeRegExp:function(a){return new RegExp(a.trim().split(/\s+/).join("|"),"i")},makeMatcher:function(a){var b=this.makeRegExp(a);return function(a){for(var c=this.fields||a.keys(),d=0,e=c.length;e>d;d++)if(b.test(a.get(c[d])+""))return!0;return!1}},searchBox:function(){return this.$el.find("input[type=search]")},search:function(a){"undefined"!=typeof a&&a.preventDefault(),this.showClearButtonMaybe();var b=_.bind(this.makeMatcher(this.searchBox().val()),this),c=this.collection;c.pageableCollection&&c.pageableCollection.getFirstPage({silent:!0}),c.reset(this.shadowCollection.filter(b),{reindex:!1})},clearButton:function(){return this.$el.find("a.clear")},clear:function(a){"undefined"!=typeof a&&a.preventDefault(),this.clearSearchBox();var b=this.collection;b.pageableCollection&&b.pageableCollection.getFirstPage({silent:!0}),b.reset(this.shadowCollection.models,{reindex:!1})},clearSearchBox:function(){this.value=null,this.searchBox().val(null),this.showClearButtonMaybe()},showClearButtonMaybe:function(){var a=this.clearButton(),b=this.searchBox().val();b?a.show():a.hide()}})),u=(new t,Backbone.View.extend({el:a("#pagination"),template:_.template(a("#tmpl-pagination").html()),initialize:function(){q.on("all",this.render,this),this.render()},events:{"click a.prev":"previous","click a.next":"next","click a.sync":"sync","click a.destroy":"destroy"},render:function(){var a=q.state;a.currentRecords=q.length;var b=new Date(+l("last_update"));return a.last_update=b.getTime()>0?b.toLocaleTimeString():"never",this.$el.html(this.template(a)),this.$el.prepend("<span></span> "),this},previous:function(){return q.hasPreviousPage()&&q.getPreviousPage(),!1},next:function(){return q.hasNextPage()&&q.getNextPage(),!1},sync:function(){return b(),!1},destroy:function(){return q.reset(),j(n),k("last_update",null),q.fetch(),!1}})),v=new u}(jQuery),function(a){"use strict";function b(a){var b=a.get("qty"),c=a.get("price"),d=0,e=0;return a.get("taxable")&&(d=a.get("taxes").line_total),e="yes"===j.prices_include_tax&&"incl"===j.tax_display_cart?b*c-d:b*c,"no"===j.round_at_subtotal&&(e=accounting.formatNumber(e)),e}function c(a,b){var c=a.get("taxes").total,d=a.get("price"),e=a.get("discount"),f=a.get("qty"),g=0,h="undefined"!=typeof b?b:c;return 0!==e&&"yes"===j.prices_include_tax&&"excl"===j.tax_display_cart?h=h/(d-c)*(d-c-e):0!==e&&(h=h/d*(d-e)),g=h*f}function d(a,b){var c=b.get("price"),d=0,e=0;return b.get("taxable")&&(d=b.get("taxes").total),"no"===j.round_at_subtotal&&(c=accounting.formatNumber(c)),e="yes"===j.prices_include_tax&&"excl"===j.tax_display_cart?c-d-a:c-a}function e(a){var b=0;return b=_.reduce(a.pluck("total_discount"),function(a,b){return a+b},0)}function f(a,b){var c=0;return c="undefined"!=typeof b?_.reduce(a.pluck("taxes.itemized."+b+".line_total"),function(a,b){return a+b},0):_.reduce(a.pluck("taxes.line_total"),function(a,b){return a+b},0)}function g(a){var b=a.get("price"),c=a.get("qty"),d=0;return d=b*c}function h(a){var b=0,c=0,d=0,e=0;return"yes"===j.calc_taxes&&"yes"===j.prices_include_tax&&"incl"===j.tax_display_cart?(b=_.reduce(a.pluck("total"),function(a,b){return a+b},0),c=_.reduce(a.pluck("total_discount"),function(a,b){return a+b},0),d=_.reduce(a.pluck("taxes.line_total"),function(a,b){return a+b},0),e=b-c+d):(b=_.reduce(a.pluck("total"),function(a,b){return a+b},0),e=b),e}function i(a){var b=0,c=0,d=0,e=0;return"yes"===j.calc_taxes&&"yes"===j.prices_include_tax&&"incl"===j.tax_display_cart?(b=_.reduce(a.pluck("total"),function(a,b){return a+b},0),c=_.reduce(a.pluck("total_discount"),function(a,b){return a+b},0),d=_.reduce(a.pluck("taxes.line_total"),function(a,b){return a+b},0),e=b-c+d):"yes"===j.calc_taxes&&"no"===j.prices_include_tax&&"excl"===j.tax_display_cart?(b=_.reduce(a.pluck("total"),function(a,b){return a+b},0),c=_.reduce(a.pluck("total_discount"),function(a,b){return a+b},0),d=_.reduce(a.pluck("taxes.line_total"),function(a,b){return a+b},0),e=b-c+d):(b=_.reduce(a.pluck("total"),function(a,b){return a+b},0),c=_.reduce(a.pluck("total_discount"),function(a,b){return a+b},0),e=b-c),e}if("undefined"==typeof pos_cart_params)return console.log("No pos_cart_params"),!1;accounting.settings=pos_cart_params.accounting.settings;var j=pos_cart_params.wc,k=Backbone.DeepModel.extend({defaults:{qty:1,total:0,discount:0,total_discount:0},initialize:function(){this.on("all",function(a){console.log(this.get("title")+" event: "+a)}),this.listenTo(this,"add change:qty change:discount",this.update)},update:function(){if(this.get("taxable")){var a=c(this);if(this.set("taxes.line_total",a),"itemized"===j.tax_total_display){var d=this.get("taxes").itemized;_.each(d,function(a){this.set("taxes.itemized."+a.rate_id+".line_total",c(this,a.tax_amount))},this)}}this.set("total_discount",this.get("qty")*this.get("discount"));var e=b(this,!1);this.set("total",e)},quantity:function(a){var b=this.get("qty");this.set("qty","increase"===a?++b:--b)}}),l=Backbone.Collection.extend({url:pos_cart_params.ajax_url,model:k,initialize:function(){this.on("all",function(a){console.log("Cart Collection event: "+a)}),this.listenTo(this,"add change:qty change:discount remove",this.updateTotals)},updateTotals:function(){if(0===this.length)return void t.removeAll();var a=[],b=h(this),c=e(this),d=f(this),g=this.tax_labels(),k=i(this);a.push({label:"Subtotal:",total:b}),0!==c&&a.push({label:"Cart Discount:",total:c}),"yes"===j.calc_taxes&&d>0&&("itemized"===j.tax_total_display?_.each(g,function(b){a.push({label:b.label+":",total:f(this,b.id)})},this):a.push({label:j.tax_label+":",total:d})),a.push({label:"Total:",total:k}),t.set(a)},tax_labels:function(){var a=[],b=this.at(0).get("taxes.itemized");return _.each(b,function(b){a.push({id:b.rate_id,label:j.tax_label+" ("+b.label+")"})}),a}}),m=Backbone.View.extend({tagName:"tr",template:_.template(a("#tmpl-cart-item").html()),events:{"click .remove a":"removeFromCart","click input":"change","keypress input":"updateOnEnter","blur input":"close"},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){var a=this.model.toJSON();return 0!==a.discount&&(a.price=a.price-a.discount,a.discounted=accounting.formatMoney(g(this.model)-a.total_discount)),a.total=accounting.formatMoney(g(this.model)),this.$el.html(this.template(a)),this.$el.find("input[type=number]").autosizeInput(),this},removeFromCart:function(b){"undefined"!=typeof b&&b.preventDefault(),this.$el.fadeOut(200,function(){a(this).remove()}),o.remove(this.model)},change:function(a){this.$(a.target).addClass("editing").focus().select()},close:function(b){var c=a(b.target),e=c.data("id"),f=parseFloat(c.val());switch(e){case"qty":if(f===this.model.get("qty"))break;if("0"===f){this.removeFromCart();break}f?(this.model.set({qty:f}),c.removeClass("editing")):c.focus();break;case"price":f?this.model.set({discount:d(f,this.model)}):c.focus()}},updateOnEnter:function(a){13===a.keyCode&&this.close(a)}}),n=Backbone.View.extend({el:a("#cart-items"),elEmpty:a("#cart-items").contents().clone(),initialize:function(){this.listenTo(o,"add",this.addOne),this.listenTo(o,"reset",this.addAll),this.listenTo(o,"all",this.render)},render:function(){console.log("render the cart items"),0===o.length&&this.emptyMessage()},addOne:function(a){if(1===o.length){this.$el.removeClass("empty").html("");{new s}}var b=new m({model:a});this.$el.append(b.render().el)},addAll:function(){o.each(this.addOne,this)},emptyMessage:function(){this.$el.addClass("empty").html(this.elEmpty)}}),o=new l,p=(new n,Backbone.Model.extend({idAttribute:"label",initialize:function(){this.on("all",function(a){console.log("Totals Model: "+a)})}})),q=Backbone.Collection.extend({model:p,initialize:function(){this.on("all",function(a){console.log("Total Collection event: "+a)})},removeAll:function(){this.each(function(a){this.remove(a)},this),this.reset()}}),r=Backbone.View.extend({tagName:"tr",model:p,template:_.template(a("#tmpl-cart-total").html()),initialize:function(){this.listenTo(this.model,"add change",this.render)},render:function(){var a=this.model.toJSON();return"Cart Discount:"===a.label&&(a.total*=-1),a.total=accounting.formatMoney(a.total),this.$el.html(this.template(a)),this}}),s=Backbone.View.extend({el:a("#cart-totals"),events:{"click #pos_checkout":"checkout"},initialize:function(){this.listenTo(t,"all",this.render),this.render()},render:function(){console.log("render the totals"),this.$el.removeClass("empty").html(""),t.each(function(a){var b=new r({model:a});this.$el.append(b.render().el)},this),t.length>0&&this.$el.append(_.template(a("#tmpl-cart-action").html()))},checkout:function(){mediator.publish("checkout",o,t)}}),t=new q;mediator.subscribe("addToCart",function(a){if(_.contains(o.pluck("id"),a.attributes.id)){var b=o.get(a.attributes.id);b.quantity("increase")}else o.add(a.attributes)})}(jQuery),function(a){"use strict";if("undefined"==typeof pos_cart_params)return console.log("No pos_cart_params"),!1;accounting.settings=pos_cart_params.accounting.settings;var b=pos_cart_params.wc,c=Backbone.Model.extend({}),d=Backbone.View.extend({model:c,tagName:"table",item_template:_.template("<tr><td><%= name %></td><td><%= quantity %></td><td><%= total %></td></tr>"),total_template:_.template('<tr><th colspan="2"><%= label %></th><td><%= total %></td></tr>'),initialize:function(){},render:function(){var a=this.model.toJSON();return this.$el.parent("div").css("padding",0),this.$el.append("<thead><tr><th>Product</th><th>Qty</th><th>Price</th></thead><tbody></tbody><tfoot></tfoot>"),_.each(a.line_items,function(a){a.total=accounting.formatMoney("yes"===b.calc_taxes&&"yes"===b.prices_include_tax&&"incl"===b.tax_display_cart?parseFloat(a.total)+parseFloat(a.total_tax):parseFloat(a.total)),this.$el.find("tbody").append(this.item_template(a))},this),this.$el.find("tfoot").append("yes"===b.calc_taxes&&"yes"===b.prices_include_tax&&"incl"===b.tax_display_cart?this.total_template({label:"Subtotal:",total:accounting.formatMoney(parseFloat(a.total))}):this.total_template({label:"Subtotal:",total:accounting.formatMoney(parseFloat(a.subtotal))})),0!==parseFloat(a.cart_discount)&&this.$el.find("tfoot").append(this.total_template({label:"Cart Discount:",total:accounting.formatMoney(-1*parseFloat(a.cart_discount))})),0!==parseFloat(a.total_tax)&&("itemized"===b.tax_total_display?_.each(a.tax_lines,function(a){this.$el.find("tfoot").append(this.total_template({label:"Tax ("+a.title+")",total:accounting.formatMoney(parseFloat(a.total))}))},this):this.$el.find("tfoot").append(this.total_template({label:"Tax:",total:accounting.formatMoney(parseFloat(a.total_tax))}))),this.$el.find("tfoot").append(this.total_template({label:"Total:",total:accounting.formatMoney(parseFloat(a.total))})),this}});mediator.subscribe("checkout",function(b){var e=b.map(function(a){return _.pick(a.toJSON(),["id","qty","price","discount","total","total_discount"])});a.post(pos_cart_params.ajax_url,{action:"pos_process_order",cart:e}).done(function(a){new Backbone.BootstrapModal({content:new d({model:new c(a.order)}),template:_.template('					<div class="modal-dialog"><div class="modal-content">					<div class="modal-header"><h4>Order '+a.order.order_number+'</h4></div>					<div class="modal-body" style="padding:0">{{content}}</div>					<div class="modal-footer"><a href="#" class="btn ok btn-primary">New Order</a></div>					</div></div>				')}).open()}).fail(function(a){console.log(a)})})}(jQuery);
//# sourceMappingURL=map/pos.map