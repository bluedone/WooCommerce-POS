function searchFocus(){$("#filter input[type=search]").focus()}function tabIndexProducts(){$("#products > tbody > tr").each(function(a){$(".add-to-cart").attr("tabindex",a)})}!function(a){"use strict";a("#user-actions-btn, #user-actions").hover(function(){a("#user-actions").show()},function(){a("#user-actions").hide()}),searchFocus(),tabIndexProducts(),a("#cart input").autosizeInput()}(jQuery),function(a){"use strict";function b(){a("#pagination").addClass("working");var b=!1,e=!1;g().then(function(a){return a.length>0?h(a):void 0}).then(function(){b=!0,i(b,e)});var f=m(l("last_update"));c(f).then(function(a){if(a>0){var b=100>a?a:100;return d(a,b,f)}}).then(function(){e=!0,i(b,e)})}function c(b){return b="undefined"!=typeof b?b:null,a.getJSON("/wc-api/v1/products/count",{"filter[updated_at_min]":b}).then(function(a){return console.log(a.count+" products need to be updated"),a.count},function(a,b,c){console.log("error "+b),console.log("incoming Text "+a.responseText),alert(c)})}function d(b,c,d){b="undefined"!=typeof b?b:10,c="undefined"!=typeof c?c:10,d="undefined"!=typeof d?d:null;for(var f=[],g=0;b>g;g+=c)f.push(e(c,g,d));return console.log(f.length+" ajax calls queued"),a.when.apply(a,f).always(function(){console.log("All products retrieved and saved")})}function e(b,c,d){return console.log("getting "+b+" products, offset by "+c),b="undefined"!=typeof b?b:10,c="undefined"!=typeof c?c:0,d="undefined"!=typeof d?d:null,a.getJSON("/wc-api/v1/products/",{"filter[limit]":b,"filter[offset]":c,"filter[updated_at_min]":d}).then(function(a){f(a)},function(a,b,c){alert(c)})}function f(a){console.log("saving "+a.products.length+" products");for(var b=0;b<a.products.length;b++){q.fullCollection.create(a.products[b],{merge:!0,success:function(a,b){console.log("saved: "+b.title)},error:function(a,b){console.log("error saving model: "+b.title)}})}}function g(){return a.getJSON(pos_cart_params.ajax_url,{action:"pos_get_product_ids"}).then(function(a){if(a instanceof Array){for(var b=q.fullCollection.models,c=[],d=0;d<b.length;d++)c.push(b[d].id);var e=_.difference(c,a);return console.log(e.length+" products need to be deleted"),e}console.log("server response is no good")},function(a,b,c){console.log("error "+b),console.log("incoming Text "+a.responseText),alert(c)})}function h(a){if(a instanceof Array){for(var b=0;b<a.length;b++){{var c=q.fullCollection.get(a[b]);c.destroy()}q.remove(c)}console.log(b+" products removed")}}function i(b,c){b&&c&&(console.log("sync is done! "),k("last_update",Date.now()),v.render(),a("#pagination").removeClass("working"))}function j(a){try{q.sync("closeall");var b=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,c=b.deleteDatabase(a.id);c.onsuccess=function(b){b.result;console.log("indexedDB: "+a.id+" deleted")},c.onerror=function(a){console.error("indexedDB.delete Error: "+a.message)},c.onblocked=function(a){console.error("indexedDB.delete Error: "+a.message)}}catch(d){console.error("Error: "+d.message)}}function k(a,b){return Modernizr.localstorage?(localStorage.setItem("posMeta-"+a,b),console.log("saved "+a+": "+b),!0):!1}function l(a){if(!Modernizr.localstorage)return!1;var b=localStorage.getItem("posMeta-"+a);return b}function m(a){var b=new Date(+a);if(b.getTime()>0){var c=new Date(b).getFullYear(),d=new Date(b).getMonth()+1,e=new Date(b).getDate();return 10>d&&(d="0"+d),10>e&&(e="0"+e),c+"-"+d+"-"+e}return null}var n={id:"productsDB",description:"Products database",migrations:[{version:"1.0",migrate:function(a,b){var c;a.db.objectStoreNames.contains("products")||(c=a.db.createObjectStore("products",{keyPath:"id"})),c=a.objectStore("products"),c.createIndex("titleIndex","title",{unique:!1}),b()}}]},o=Backbone.Model.extend({database:n,storeName:"products",initialize:function(){this.on("all",function(a){console.log(this.get("title")+" event: "+a)})}}),p=Backbone.PageableCollection.extend({database:n,storeName:"products",model:o,mode:"client",state:{pageSize:5,totalRecords:null,sortKey:"updated_at",order:1},initialize:function(){this.on("all",function(a){console.log("Product Collection event: "+a)})}}),q=new p,r=Backbone.View.extend({tagName:"tr",model:new o,template:_.template(a("#tmpl-product").html()),events:{"click a.add-to-cart":"addToCart"},initialize:function(){this.model.on("all",function(a){console.log("Product View event: "+a)})},render:function(){var a=this.model.toJSON();return console.log(a),this.$el.html(this.template(a)),this},addToCart:function(a){a.preventDefault(),mediator.publish("addToCart",this.model)}}),s=Backbone.View.extend({el:a("#product-list"),model:q,elEmpty:a("#product-list").contents().clone(),initialize:function(){this.model.on("all",function(a){console.log("Product List event: "+a)}),this.model.on("all",this.render,this),q.fetch().done(function(){console.log("init collection with "+q.length+" products from indexedDB")}),b()},render:function(){console.log("render the products"),0===q.length?this.emptyMessage():this.$el.removeClass("empty").html(""),q.each(function(a){var b=new r({model:a});this.$el.append(b.render().el)},this)},emptyMessage:function(){this.$el.addClass("empty").html(this.elEmpty)}}),t=(new s,Backbone.View.extend({el:a("#filter"),collection:q,fields:["title"],events:{"keydown input[type=search]":"search",submit:"search","click a.clear":"clear"},wait:149,initialize:function(){this._debounceMethods(["search","clear"]);var a=this.collection=this.collection.fullCollection||this.collection,b=this.shadowCollection=a.clone();this.listenTo(a,"add",function(a,c,d){b.add(a,d)}),this.listenTo(a,"remove",function(a,c,d){b.remove(a,d)}),this.listenTo(a,"sort",function(a){this.searchBox().val()||b.reset(a.models)}),this.listenTo(a,"reset",function(a,c){c=_.extend({reindex:!0},c||{}),c.reindex&&null==c.from&&null==c.to&&b.reset(a.models)})},_debounceMethods:function(a){_.isString(a)&&(a=[a]),this.undelegateEvents();for(var b=0,c=a.length;c>b;b++){var d=a[b],e=this[d];this[d]=_.debounce(e,this.wait)}this.delegateEvents()},makeRegExp:function(a){return new RegExp(a.trim().split(/\s+/).join("|"),"i")},makeMatcher:function(a){var b=this.makeRegExp(a);return function(a){for(var c=this.fields||a.keys(),d=0,e=c.length;e>d;d++)if(b.test(a.get(c[d])+""))return!0;return!1}},searchBox:function(){return this.$el.find("input[type=search]")},search:function(a){"undefined"!=typeof a&&a.preventDefault(),this.showClearButtonMaybe();var b=_.bind(this.makeMatcher(this.searchBox().val()),this),c=this.collection;c.pageableCollection&&c.pageableCollection.getFirstPage({silent:!0}),c.reset(this.shadowCollection.filter(b),{reindex:!1})},clearButton:function(){return this.$el.find("a.clear")},clear:function(a){"undefined"!=typeof a&&a.preventDefault(),this.clearSearchBox();var b=this.collection;b.pageableCollection&&b.pageableCollection.getFirstPage({silent:!0}),b.reset(this.shadowCollection.models,{reindex:!1})},clearSearchBox:function(){this.value=null,this.searchBox().val(null),this.showClearButtonMaybe()},showClearButtonMaybe:function(){var a=this.clearButton(),b=this.searchBox().val();b?a.show():a.hide()}})),u=(new t,Backbone.View.extend({el:a("#pagination"),template:_.template(a("#tmpl-pagination").html()),initialize:function(){q.on("all",this.render,this),this.render()},events:{"click a.prev":"previous","click a.next":"next","click a.sync":"sync","click a.destroy":"destroy"},render:function(){var a=q.state;a.currentRecords=q.length;var b=new Date(+l("last_update"));return a.last_update=b.getTime()>0?b.toLocaleTimeString():"never",this.$el.html(this.template(a)),this.$el.prepend("<span></span> "),this},previous:function(){return q.hasPreviousPage()&&q.getPreviousPage(),!1},next:function(){return q.hasNextPage()&&q.getNextPage(),!1},sync:function(){return b(),!1},destroy:function(){return q.reset(),j(n),k("last_update",null),q.fetch(),!1}})),v=new u}(jQuery),function(a){"use strict";function b(a){var b=parseFloat(a.get("price")),c=parseFloat(a.get("discount")),d=parseFloat(a.get("taxes").total);return"yes"===i.prices_include_tax&&"excl"===i.tax_display_cart?b=b-c-d:b-=c,"no"===i.round_at_subtotal&&(b=accounting.formatNumber(b)),b}function c(a,b){var c=a.get("qty"),d=a.get("price"),e=a.get("discount"),f=a.get("taxes").total,g=0;return b="undefined"!=typeof b?b:!0,b||(e=0),"yes"===i.prices_include_tax&&"excl"===i.tax_display_cart?(d-=f,g=c*(d-e)):g=c*(d-e),"no"===i.round_at_subtotal&&(g=accounting.formatNumber(g)),g}function d(a,b){var c=a.get("taxes").total,d=a.get("price"),e=a.get("discount"),f=a.get("qty"),g=0,h="undefined"!=typeof b?b:c;return 0!==e&&(h="yes"===i.prices_include_tax?h/(d-c)*(d-c-e):h/d*(d-e)),g=h*f}function e(a,b){var c=b.get("price"),d=b.get("taxes").total,e=0;return"no"===i.round_at_subtotal&&(c=accounting.formatNumber(c)),e="yes"===i.prices_include_tax&&"excl"===i.tax_display_cart?c-d-a:c-a}function f(a){var b=0;return a.each(function(a){b+=a.get("total")}),b}function g(a){var b=0;return a.each(function(a){b+=a.get("qty")*a.get("discount")}),b}function h(a,b){var c=0;return a.each("undefined"!=typeof b?function(a){c+=a.get("taxes.itemized."+b+".line_total")}:function(a){c+=a.get("taxes").line_total}),c}if("undefined"==typeof pos_cart_params)return console.log("No pos_cart_params"),!1;accounting.settings=pos_cart_params.accounting.settings;var i=pos_cart_params.wc,j=Backbone.DeepModel.extend({defaults:{qty:1,total:0,discount:0},initialize:function(){this.on("all",function(a){console.log(this.get("title")+" event: "+a)}),this.listenTo(this,"add change:qty change:discount",this.total),this.listenTo(this,"add change:qty change:discount",this.taxes)},total:function(){var a=c(this,!1);this.set("total",a)},taxes:function(){var a=d(this);this.set("taxes.line_total",a);var b=this.get("taxes").itemized;_.each(b,function(a){this.set("taxes.itemized."+a.rate_id+".line_total",d(this,a.tax_amount))},this)},quantity:function(a){var b=this.get("qty");this.set("qty","increase"===a?++b:--b)}}),k=Backbone.Collection.extend({url:pos_cart_params.ajax_url,model:j,initialize:function(){this.on("all",function(a){console.log("Cart Collection event: "+a)}),this.listenTo(this,"add change:qty change:discount remove",this.updateTotals)},updateTotals:function(){if(0===this.length)return void s.removeAll();var a=[],b=f(this),c=g(this),d=h(this),e=this.tax_labels();a.push({label:"Subtotal:",total:b}),0!==c&&a.push({label:"Cart Discount:",total:c}),d>0&&("itemized"===i.tax_total_display?_.each(e,function(b){a.push({label:b.label+":",total:h(this,b.id)})},this):a.push({label:i.tax_label+":",total:d})),a.push({label:"Total:",total:b-c+d}),s.set(a)},tax_labels:function(){var a=[],b=this.at(0).get("taxes.itemized");return _.each(b,function(b){a.push({id:b.rate_id,label:i.tax_label+" ("+b.label+")"})}),a}}),l=Backbone.View.extend({tagName:"tr",template:_.template(a("#tmpl-cart-item").html()),events:{"click .remove a":"removeFromCart","click input":"change","keypress input":"updateOnEnter","blur input":"close"},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){var a=this.model.toJSON();return a.prediscount=accounting.formatMoney(a.total),a.price=b(this.model),a.total=accounting.formatMoney(c(this.model)),"excl"===i.tax_display_cart&&(a.total=a.total+" <small>(ex. tax)</small>"),this.$el.html(this.template(a)),this.$el.find("input[type=number]").autosizeInput(),this},removeFromCart:function(b){"undefined"!=typeof b&&b.preventDefault(),this.$el.fadeOut(200,function(){a(this).remove()}),this.model.destroy()},change:function(a){this.$(a.target).addClass("editing").focus().select()},close:function(b){var c=a(b.target),d=c.data("id"),f=parseFloat(c.val());switch(d){case"qty":if(f===this.model.get("qty"))break;if("0"===f){this.removeFromCart();break}f?(this.model.set({qty:f}),c.removeClass("editing")):c.focus();break;case"price":f?this.model.set({discount:e(f,this.model)}):c.focus()}},updateOnEnter:function(a){13===a.keyCode&&this.close(a)}}),m=Backbone.View.extend({el:a("#cart-items"),elEmpty:a("#cart-items").contents().clone(),initialize:function(){this.listenTo(n,"add",this.addOne),this.listenTo(n,"reset",this.addAll),this.listenTo(n,"all",this.render)},render:function(){console.log("render the cart items"),0===n.length&&this.emptyMessage()},addOne:function(a){if(1===n.length){this.$el.removeClass("empty").html("");{new r}}var b=new l({model:a});this.$el.append(b.render().el)},addAll:function(){n.each(this.addOne,this)},emptyMessage:function(){this.$el.addClass("empty").html(this.elEmpty)}}),n=new k,o=(new m,Backbone.Model.extend({idAttribute:"label",initialize:function(){this.on("all",function(a){console.log("Totals Model: "+a)})}})),p=Backbone.Collection.extend({model:o,initialize:function(){this.on("all",function(a){console.log("Total Collection event: "+a)})},removeAll:function(){this.each(function(a){this.remove(a)},this),this.reset()}}),q=Backbone.View.extend({tagName:"tr",model:o,template:_.template(a("#tmpl-cart-total").html()),initialize:function(){this.listenTo(this.model,"add change",this.render)},render:function(){var a=this.model.toJSON();return"Cart Discount:"===a.label&&(a.total*=-1),a.total=accounting.formatMoney(a.total),"Subtotal:"===a.label&&"excl"===i.tax_display_cart&&(a.total=a.total+" <small>(ex. tax)</small>"),this.$el.html(this.template(a)),this}}),r=Backbone.View.extend({el:a("#cart-totals"),initialize:function(){this.listenTo(s,"all",this.render),this.render()},render:function(){console.log("render the totals"),this.$el.removeClass("empty").html(""),s.each(function(a){var b=new q({model:a});this.$el.append(b.render().el)},this),s.length>0&&this.$el.append(_.template(a("#tmpl-cart-action").html()))}}),s=new p;mediator.subscribe("addToCart",function(a){if(_.contains(n.pluck("id"),a.attributes.id)){var b=n.get(a.attributes.id);b.quantity("increase")}else n.add(a.attributes)})}(jQuery),function(a){"use strict";a("button.btn-checkout").click(function(b){b.preventDefault();var c={action:"pos_process_order"};a.post(pos_cart_params.ajax_url,c,function(b){return b?b.error?void console.log(b.error):void a("#cart").html(b):void console.log("No response from server")})})}(jQuery);
//# sourceMappingURL=map/pos.map