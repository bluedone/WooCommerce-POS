!function(a){"use strict";if(a("#filter input[type=search]").focus(),!Modernizr.indexeddb){var b=a('<div class="modal fade"><div class="modal-dialog"><div class="modal-content"></div></div></div>');a.get(pos_cart_params.ajax_url,{action:"pos_get_modal",template:"browser-support"}).done(function(a){b.modal("show").find(".modal-content").html(a)})}}(jQuery),function(){var a=jQuery;a.fn.extend({autoGrowInput:function(){return this.each(function(){var b=a(this),c=a("<div />").css({opacity:0,top:-9999,left:-9999,position:"absolute",whiteSpace:"nowrap"}).addClass("POS-input-width-tester"),d="keydown keyup input propertychange change";b.next(".POS-input-width-tester").remove(),b.after(c),b.unbind(d).bind(d,function(a,d){d&&(a=d);var e=b.val();e=e.replace(/&/g,"&amp;").replace(/\s/g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),c.html(e);var f=c.width();b.width(f+20)}),b.trigger("keydown")})}})}(),function(a){"use strict";function b(){a("#pagination").addClass("working");var b=!1,e=!1;g().then(function(a){return a.length>0?h(a):void 0}).then(function(){b=!0,i(b,e)});var f=m(l("last_update"));c(f).then(function(a){if(a>0){var b=100>a?a:100;return d(a,b,f)}}).then(function(){e=!0,i(b,e)})}function c(b){return b="undefined"!=typeof b?b:null,a.getJSON("/wc-api/v1/products/count",{"filter[updated_at_min]":b}).then(function(a){return console.log(a.count+" products need to be updated"),a.count},function(a,b,c){console.log("error "+b),console.log("incoming Text "+a.responseText),alert(c)})}function d(b,c,d){b="undefined"!=typeof b?b:10,c="undefined"!=typeof c?c:10,d="undefined"!=typeof d?d:null;for(var f=[],g=0;b>g;g+=c)f.push(e(c,g,d));return console.log(f.length+" ajax calls queued"),a.when.apply(a,f).always(function(){console.log("All products retrieved and saved")})}function e(b,c,d){return console.log("getting "+b+" products, offset by "+c),b="undefined"!=typeof b?b:10,c="undefined"!=typeof c?c:0,d="undefined"!=typeof d?d:null,a.getJSON("/wc-api/v1/products/",{"filter[limit]":b,"filter[offset]":c,"filter[updated_at_min]":d}).then(function(a){f(a)},function(a,b,c){alert(c)})}function f(a){console.log("saving "+a.products.length+" products"),_.each(a.products,function(a){s.fullCollection.create(a,{merge:!0,success:function(a,b){console.log("saved: "+b.title)},error:function(a,b){console.log("error saving model: "+b.title)}})})}function g(){return a.getJSON(pos_cart_params.ajax_url,{action:"pos_get_product_ids"}).then(function(a){if(a instanceof Array){for(var b=s.fullCollection.models,c=[],d=0;d<b.length;d++)c.push(b[d].id);var e=_.difference(c,a);return console.log(e.length+" products need to be deleted"),e}console.log("server response is no good")},function(a,b,c){console.log("error "+b),console.log("incoming Text "+a.responseText),alert(c)})}function h(a){if(a instanceof Array){for(var b=0;b<a.length;b++){{var c=s.fullCollection.get(a[b]);c.destroy()}s.remove(c)}console.log(b+" products removed")}}function i(b,c){b&&c&&(console.log("sync is done! "),k("last_update",Date.now()),v.render(),a("#pagination").removeClass("working"))}function j(a){try{s.sync("closeall");var b=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,c=b.deleteDatabase(a.id);c.onsuccess=function(b){b.result;console.log("indexedDB: "+a.id+" deleted")},c.onerror=function(a){console.error("indexedDB.delete Error: "+a.message)},c.onblocked=function(a){console.error("indexedDB.delete Error: "+a.message)}}catch(d){console.error("Error: "+d.message)}}function k(a,b){return Modernizr.localstorage?(localStorage.setItem("posMeta-"+a,b),console.log("saved "+a+": "+b),!0):!1}function l(a){if(!Modernizr.localstorage)return!1;var b=localStorage.getItem("posMeta-"+a);return b}function m(a){var b=new Date(+a);if(b.getTime()>0){var c=new Date(b).getFullYear(),d=new Date(b).getMonth()+1,e=new Date(b).getDate();return 10>d&&(d="0"+d),10>e&&(e="0"+e),c+"-"+d+"-"+e}return null}var n={id:"productsDB",description:"POS products database",migrations:[{version:"1",migrate:function(a,b){var c;a.db.objectStoreNames.contains("products")||(c=a.db.createObjectStore("products",{keyPath:"id"})),c=a.objectStore("products"),c.createIndex("titleIndex","title",{unique:!1}),b()}}]},o=Backbone.Model.extend({database:n,storeName:"products"}),p=Backbone.PageableCollection.extend({database:n,storeName:"products",model:o,mode:"client",state:{pageSize:5,totalRecords:null,sortKey:"updated_at",order:1},initialize:function(){}}),q=Backbone.View.extend({tagName:"tr",template:_.template(a("#tmpl-product").html()),events:{"click a.add-to-cart":"addToCart"},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){var a=this.model.toJSON();return this.$el.html(this.template(a)),this},addToCart:function(a){a.preventDefault(),mediator.publish("addToCart",this.model)}}),r=Backbone.View.extend({el:a("#product-list"),elEmpty:a("#product-list").contents().clone(),initialize:function(){this.listenTo(s,"all",this.render),s.fetch(),b()},render:function(){0===s.length?this.emptyMessage():this.$el.removeClass("empty").html(""),s.each(function(a){var b=new q({model:a});this.$el.append(b.render().el)},this)},emptyMessage:function(){this.$el.addClass("empty").html(this.elEmpty)}}),s=new p,t=(new r,Backbone.View.extend({el:a("#filter"),collection:s,fields:["title"],events:{"keydown input[type=search]":"search",submit:"search","click a.clear":"clear"},wait:149,initialize:function(){this._debounceMethods(["search","clear"]);var a=this.collection=this.collection.fullCollection||this.collection,b=this.shadowCollection=a.clone();this.listenTo(a,"add",function(a,c,d){b.add(a,d)}),this.listenTo(a,"remove",function(a,c,d){b.remove(a,d)}),this.listenTo(a,"sort",function(a){this.searchBox().val()||b.reset(a.models)}),this.listenTo(a,"reset",function(a,c){c=_.extend({reindex:!0},c||{}),c.reindex&&null==c.from&&null==c.to&&b.reset(a.models)})},_debounceMethods:function(a){_.isString(a)&&(a=[a]),this.undelegateEvents();for(var b=0,c=a.length;c>b;b++){var d=a[b],e=this[d];this[d]=_.debounce(e,this.wait)}this.delegateEvents()},makeRegExp:function(a){return new RegExp(a.trim().split(/\s+/).join("|"),"i")},makeMatcher:function(a){var b=this.makeRegExp(a);return function(a){for(var c=this.fields||a.keys(),d=0,e=c.length;e>d;d++)if(b.test(a.get(c[d])+""))return!0;return!1}},searchBox:function(){return this.$el.find("input[type=search]")},search:function(a){"undefined"!=typeof a&&a.preventDefault(),this.showClearButtonMaybe();var b=_.bind(this.makeMatcher(this.searchBox().val()),this),c=this.collection;c.pageableCollection&&c.pageableCollection.getFirstPage({silent:!0}),c.reset(this.shadowCollection.filter(b),{reindex:!1})},clearButton:function(){return this.$el.find("a.clear")},clear:function(a){"undefined"!=typeof a&&a.preventDefault(),this.clearSearchBox();var b=this.collection;b.pageableCollection&&b.pageableCollection.getFirstPage({silent:!0}),b.reset(this.shadowCollection.models,{reindex:!1})},clearSearchBox:function(){this.value=null,this.searchBox().val(null),this.showClearButtonMaybe()},showClearButtonMaybe:function(){var a=this.clearButton(),b=this.searchBox().val();b?a.show():a.hide()}})),u=(new t,Backbone.View.extend({el:a("#pagination"),template:_.template(a("#tmpl-pagination").html()),initialize:function(){s.on("all",this.render,this),this.render()},events:{"click a.prev":"previous","click a.next":"next","click a.sync":"sync","click a.destroy":"destroy"},render:function(){var a=s.state;a.currentRecords=s.length;var b=new Date(+l("last_update"));return a.last_update=b.getTime()>0?b.toLocaleTimeString():"never",this.$el.html(this.template(a)),this.$el.prepend("<span></span> "),this},previous:function(){return s.hasPreviousPage()&&s.getPreviousPage(),!1},next:function(){return s.hasNextPage()&&s.getNextPage(),!1},sync:function(){return b(),!1},destroy:function(){return s.reset(),j(n),k("last_update",null),s.fetch(),!1}})),v=new u}(jQuery),function(a){"use strict";function b(a){var b=a.get("qty"),c=a.get("price"),d=0,e=0;return a.get("taxable")&&(d=a.get("taxes").line_total),e="yes"===g.prices_include_tax?b*c-d:b*c,"no"===g.round_at_subtotal&&(e=accounting.formatNumber(e)),e}function c(a,b){var c=parseFloat(a.get("taxes.total")),d=parseFloat(a.get("price")),e=parseFloat(a.get("discount")),f=parseFloat(a.get("qty")),h="undefined"!=typeof b?b:c;return 0!==e&&"no"===g.prices_include_tax&&"incl"===g.tax_display_cart?h=h/(d+c)*(d+c-e):0!==e&&"yes"===g.prices_include_tax&&"excl"===g.tax_display_cart?h=h/(d-c)*(d-c-e):0!==e&&(h=h/d*(d-e)),h*f}function d(a,b){var c=parseFloat(b.get("price")),d=0,e=0;return b.get("taxable")&&(d=parseFloat(b.get("taxes.total"))),e="yes"===g.calc_taxes&&"no"===g.prices_include_tax&&"incl"===g.tax_display_cart?c+d-a:"yes"===g.calc_taxes&&"yes"===g.prices_include_tax&&"excl"===g.tax_display_cart?c-d-a:c-a,"no"===g.round_at_subtotal&&(e=accounting.formatNumber(e)),e}function e(a){var b=parseFloat(a.get("price")),c=0;return a.get("taxable")&&(c=parseFloat(a.get("taxes.total"))),"yes"===g.calc_taxes&&"no"===g.prices_include_tax&&"incl"===g.tax_display_cart?b+=c:"yes"===g.calc_taxes&&"yes"===g.prices_include_tax&&"excl"===g.tax_display_cart&&(b-=c),b}function f(a){var b=parseFloat(a.get("price")),c=parseFloat(a.get("qty")),d=0,e=0;return a.get("taxable")&&(e=parseFloat(a.get("taxes.total"))),d="yes"===g.calc_taxes&&"no"===g.prices_include_tax&&"incl"===g.tax_display_cart?(b+e)*c:"yes"===g.calc_taxes&&"yes"===g.prices_include_tax&&"excl"===g.tax_display_cart?(b-e)*c:b*c}if("undefined"==typeof pos_cart_params)return console.log("No pos_cart_params"),!1;accounting.settings=pos_cart_params.accounting.settings;{var g=pos_cart_params.wc,h=Backbone.DeepModel.extend({defaults:{qty:1,total:0,discount:0,total_discount:0},initialize:function(){this.listenTo(this,"add change:qty change:discount",this.updateLineTotals)},updateLineTotals:function(){var a=this.get("qty");if(this.get("taxable")){var d=c(this);if(this.set("taxes.line_total",d),this.set("taxes.line_subtotal",this.get("taxes.total")*a),"itemized"===g.tax_total_display){var e=this.get("taxes").itemized;_.each(e,function(b){this.set("taxes.itemized."+b.rate_id+".line_total",c(this,b.tax_amount)),this.set("taxes.itemized."+b.rate_id+".line_subtotal",b.tax_amount*a)},this)}}this.set("total_discount",this.get("discount")*a);var f=b(this);this.set("total",f)},quantity:function(a){var b=this.get("qty");this.set("qty","increase"===a?++b:--b)}}),i=Backbone.Collection.extend({url:pos_cart_params.ajax_url,model:h,initialize:function(){this.on("all",function(a){console.log("Cart Collection event: "+a)})}}),j=Backbone.View.extend({tagName:"tr",template:_.template(a("#tmpl-cart-item").html()),events:{"click .remove a":"removeFromCart","click input":"change","keypress input":"updateOnEnter","blur input":"close"},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){var a=this.model.toJSON();return a.price=e(this.model),0!==a.discount&&(a.price=a.price-a.discount,a.discounted=accounting.formatMoney(f(this.model)-a.total_discount)),a.total=accounting.formatMoney(f(this.model)),this.$el.html(this.template(a)),this.$("input[type=number]").autoGrowInput(),this},removeFromCart:function(b){"undefined"!=typeof b&&b.preventDefault(),this.$el.fadeOut(200,function(){a(this).remove()}),l.remove(this.model)},change:function(a){this.$(a.target).addClass("editing").focus().select()},close:function(b){var c=a(b.target),e=c.data("id"),f=parseFloat(c.val());switch(e){case"qty":if(f===this.model.get("qty"))break;if(0===f){this.removeFromCart();break}f?(this.model.set({qty:f}),c.removeClass("editing")):c.focus();break;case"price":f?this.model.set({discount:d(f,this.model)}):c.focus()}},updateOnEnter:function(a){13===a.keyCode&&this.close(a)}}),k=Backbone.View.extend({el:a("#cart-items"),elEmpty:a("#cart-items").contents().clone(),initialize:function(){this.listenTo(l,"add",this.addOne),this.listenTo(l,"reset",this.addAll),this.listenTo(l,"remove",this.render)},render:function(){0===l.length&&this.emptyMessage()},addOne:function(a){1===l.length&&this.$el.removeClass("empty").html("");var b=new j({model:a});this.$el.append(b.render().el)},addAll:function(){l.each(this.addOne,this)},emptyMessage:function(){this.$el.addClass("empty").html(this.elEmpty)}}),l=new i,m=(new k,Backbone.Model.extend({defaults:{label:"",total:0},idAttribute:"label",initialize:function(){}})),n=Backbone.Collection.extend({model:m,comparator:"id",initialize:function(){this.listenTo(l,"change remove",this.updateTotals)},updateTotals:function(){var a=[],b=0,c=0,d=0,e=0,f=[];this.reset(),0!==l.length&&(b=_.reduce(l.pluck("total"),function(a,b){return a+b},0),a.push({id:1,label:"Subtotal:",total:b}),c=_.reduce(l.pluck("total_discount"),function(a,b){return a+b},0),0!==c&&a.push({id:2,label:"Cart Discount:",total:c}),"yes"===g.calc_taxes&&(f=this.tax_labels(),d=_.reduce(l.pluck("taxes.line_total"),function(a,b){return a+b},0),0!==d&&("itemized"===g.tax_total_display?_.each(f,function(b){var c=3;d=_.reduce(l.pluck("taxes.itemized."+b.id+".line_total"),function(a,b){return a+b},0),a.push({id:c,label:b.label,total:d}),c++},this):a.push({id:3,label:f[0].label,total:d}))),"yes"===g.calc_taxes&&"no"===g.prices_include_tax&&"incl"===g.tax_display_cart?(d=_.reduce(l.pluck("taxes.line_subtotal"),function(a,b){return a+b},0),a[0].total=b+d):"yes"===g.calc_taxes&&"yes"===g.prices_include_tax&&"incl"===g.tax_display_cart&&(d=_.reduce(l.pluck("taxes.line_total"),function(a,b){return a+b},0),a[0].total=b+d),e=b-c+d,a.push({id:100,label:"Total:",total:e}),this.reset(a))},tax_labels:function(){var a=[],b="",c=l.at(0).get("taxes.itemized");return"yes"===g.calc_taxes&&"incl"===g.tax_display_cart&&(b="includes "),"itemized"===g.tax_total_display?_.each(c,function(c){a.push({id:c.rate_id,label:b+g.tax_label+" ("+c.label+"):"})}):a.push({id:0,label:b+g.tax_label+":"}),a}}),o=Backbone.View.extend({tagName:"tr",template:_.template(a("#tmpl-cart-total").html()),initialize:function(){},render:function(){var a=this.model.toJSON();return"Cart Discount:"===a.label&&(a.total*=-1),a.total=accounting.formatMoney(a.total),this.$el.html(this.template(a)),this}}),p=Backbone.View.extend({el:a("#cart-totals"),events:{"click #pos_checkout":"checkout"},initialize:function(){this.listenTo(q,"reset",this.render)},render:function(){this.$el.removeClass("empty").html(""),q.each(function(a){var b=new o({model:a});this.$el.append(b.render().el)},this),q.length>0&&this.$el.append(_.template(a("#tmpl-cart-action").html()))},checkout:function(){mediator.publish("checkout",l,q)}}),q=new n;new p}mediator.subscribe("addToCart",function(a){if(_.contains(l.pluck("id"),a.attributes.id)){var b=l.get(a.attributes.id);b.quantity("increase")}else l.add(a.attributes)})}(jQuery),function(a){"use strict";if("undefined"==typeof pos_cart_params)return console.log("No pos_cart_params"),!1;accounting.settings=pos_cart_params.accounting.settings;var b,c=pos_cart_params.wc,d=Backbone.Model.extend({}),e=Backbone.View.extend({model:d,tagName:"table",item_template:_.template("<tr><td><%= name %></td><td><%= quantity %></td><td><%= total %></td></tr>"),total_template:_.template('<tr><th colspan="2"><%= label %></th><td><%= total %></td></tr>'),initialize:function(){},render:function(){var a=this.model.toJSON();return this.$el.parent("div").css("padding",0),this.$el.append("<thead><tr><th>Product</th><th>Qty</th><th>Price</th></thead><tbody></tbody><tfoot></tfoot>"),_.each(a.line_items,function(a){a.total=accounting.formatMoney("yes"===c.calc_taxes&&"yes"===c.prices_include_tax&&"incl"===c.tax_display_cart?parseFloat(a.total)+parseFloat(a.total_tax):parseFloat(a.total)),this.$el.find("tbody").append(this.item_template(a))},this),this.$el.find("tfoot").append("yes"===c.calc_taxes&&"yes"===c.prices_include_tax&&"incl"===c.tax_display_cart?this.total_template({label:"Subtotal:",total:accounting.formatMoney(parseFloat(a.total))}):this.total_template({label:"Subtotal:",total:accounting.formatMoney(parseFloat(a.subtotal))})),0!==parseFloat(a.cart_discount)&&this.$el.find("tfoot").append(this.total_template({label:"Cart Discount:",total:accounting.formatMoney(-1*parseFloat(a.cart_discount))})),0!==parseFloat(a.total_tax)&&("itemized"===c.tax_total_display?_.each(a.tax_lines,function(a){this.$el.find("tfoot").append(this.total_template({label:"Tax ("+a.title+")",total:accounting.formatMoney(parseFloat(a.total))}))},this):this.$el.find("tfoot").append(this.total_template({label:"Tax:",total:accounting.formatMoney(parseFloat(a.total_tax))}))),this.$el.find("tfoot").append(this.total_template({label:"Total:",total:accounting.formatMoney(parseFloat(a.total))})),console.log("wc: "+a.total+", pos: "+b),parseFloat(a.total)!==parseFloat(b)&&this.$el.find("tfoot").append('<tr><td colspan="3"><div class="alert alert-danger textcenter"><i class="fa fa-warning"></i> <strong>Total mismatch!</strong> The total calculated at the POS is different to the total calculated by WooCommerce. Please report this problem to <a href="mailto:support@woopos.com.au?subject=Total mismatch">support</a> so we can look into it.</div></td></tr>'),this}});mediator.subscribe("checkout",function(c,f){b=accounting.formatNumber(f.get("Total:").toJSON().total);var g=c.map(function(a){return _.pick(a.toJSON(),["id","qty","price","discount","total","total_discount"])});a.post(pos_cart_params.ajax_url,{action:"pos_process_order",cart:g}).done(function(a){new Backbone.BootstrapModal({content:new e({model:new d(a.order)}),template:_.template('<div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h4>Order '+a.order.order_number+'</h4></div><div class="modal-body" style="padding:0">{{content}}</div><div class="modal-footer"><a href="#" class="btn ok btn-primary">New Order</a></div></div></div>')}).open()}).fail(function(a){console.log(a)})})}(jQuery);
//# sourceMappingURL=map/pos.map