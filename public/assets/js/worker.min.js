var db,storeCount=0,wc_api_url="/wc-api/v1/",ajaxLimit=50;addEventListener("message",function(a){var b=a.data;switch(b.cmd){case"sync":"undefined"!=typeof indexedDB&&openDB(),"undefined"!=typeof b.wc_api_url&&""!==b.wc_api_url&&(wc_api_url=b.wc_api_url),getUpdateCount(b.last_update);break;case"clear":deleteDB();break;case"stop":self.postMessage({status:"complete",msg:"Worker stopped: "+b.msg}),close();break;default:self.postMessage({status:"complete",msg:"Unknown command: "+b.cmd})}},!1);var getJSON=function(a,b,c){var d="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");d.open("get",a,!0),d.onreadystatechange=function(){var a,e;if(4===d.readyState)if(a=d.status,200===a)try{e=JSON.parse(d.responseText),b&&b(e)}catch(f){c&&c(f)}else c&&c(a)},d.send()},openDB=function(){var a=indexedDB.open("productsDB");a.onupgradeneeded=function(){},a.onsuccess=function(a){db=a.target.result},a.onerror=function(){self.postMessage({status:"error",msg:"idberror"})}},getUpdateCount=function(a){a="undefined"!=typeof a?a:null;var b=["filter[updated_at_min]="+a,"pos=1"];getJSON(wc_api_url+"products/count?"+b.join("&"),function(b){b.count>0?(b.count>ajaxLimit&&self.postMessage({status:"showModal",type:"downloadProgress",total:b.count}),getProducts(b.count,ajaxLimit,a)):self.postMessage({status:"complete",msg:"0 products need to be updated"})},function(a){self.postMessage({status:"error",msg:a})})},getProducts=function(a,b,c){a="undefined"!=typeof a?a:10,b="undefined"!=typeof b?b:10,c="undefined"!=typeof c?c:null;var d=0,e=0,f=1e3;!function g(d,f){setTimeout(function(){var h=["filter[limit]="+b,"filter[offset]="+d,"filter[updated_at_min]="+c,"pos=1"];getJSON(wc_api_url+"products?"+h.join("&"),function(c){next=d+b,a>next&&g(next),storeProducts(c.products,a)},function(a){503===a?++e<10?(f+=1e3,g(d,f)):self.postMessage({status:"error",msg:a}):self.postMessage(401===a?{status:"error",msg:a}:{status:"error",msg:"dlerror"})})},f)}(d,f)},storeProducts=function(a,b){if("object"!=typeof db)return self.postMessage({status:"noIndexedDB",products:a,progress:storeCount,count:b}),void(storeCount+=a.length);var c=db.transaction(["products"],"readwrite"),d=c.objectStore("products"),e=0;!function f(){if(e<a.length){var c=d.put(a[e]);c.onsuccess=f,c.onerror=function(){self.postMessage({status:"error",msg:"idberror"})},e++}else storeCount+=e,self.postMessage({status:"progress",count:storeCount}),storeCount===b&&self.postMessage({status:"complete",msg:"Sync complete!"})}()};