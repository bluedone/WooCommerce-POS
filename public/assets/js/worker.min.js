function getJSON(a,b,c){var d=new XMLHttpRequest;d.open("get",a,!0),d.responseType="json",d.onload=function(){var a=d.status;200===a?b&&b(d.response):c&&c(a)},d.send()}var db,storeCount=0,ajaxLimit=1e3;addEventListener("message",function(a){var b=a.data;switch(b.cmd){case"sync":"undefined"!=typeof indexedDB&&openDB(),getUpdateCount(b.last_update);break;case"clear":deleteDB();break;case"stop":self.postMessage("Worker stopped: "+b.msg),close();break;default:self.postMessage("Unknown command: "+b.cmd)}},!1);var openDB=function(){var a=indexedDB.open("productsDB",1);a.onupgradeneeded=function(){},a.onsuccess=function(a){db=a.target.result},a.onerror=function(a){}},getUpdateCount=function(a){a="undefined"!=typeof a?a:null;var b=["filter[updated_at_min]="+a,"pos=1"];getJSON("/wc-api/v1/products/count?"+b.join("&"),function(b){b.count>0?(self.postMessage({status:"success",msg:b.count+" products need to be updated"}),queueProducts(b.count,ajaxLimit,a)):self.postMessage({status:"complete",msg:"0 products need to be updated"})},function(){self.postMessage({status:"error",msg:"Error getting update count from the server"})})},queueProducts=function(a,b,c){a="undefined"!=typeof a?a:10,b="undefined"!=typeof b?b:10,c="undefined"!=typeof c?c:null;for(var d=[],e=0;a>e;e+=b)d.push(storeProducts(a,b,e,c))},storeProducts=function(a,b,c,d){b="undefined"!=typeof b?b:100,c="undefined"!=typeof c?c:0,d="undefined"!=typeof d?d:null;var e=["filter[limit]="+b,"filter[offset]="+c,"filter[updated_at_min]="+d,"pos=1"];getJSON("/wc-api/v1/products?"+e.join("&"),function(b){function c(){if(g<b.products.length){var d=f.put(b.products[g]);d.onsuccess=c,d.onerror=function(a){self.postMessage({status:"error",msg:"Problem saving "+a.target.result})},g++}else storeCount+=g,self.postMessage({status:"success",msg:"Saved "+storeCount+" of "+a+" products"}),storeCount===a&&self.postMessage({status:"complete",msg:"Sync complete!"})}if("object"!=typeof db){var d=!1;return storeCount+=b.products.length,storeCount===a&&(d=!0),void self.postMessage({status:"noIndexedDB",products:b,last:d})}var e=db.transaction(["products"],"readwrite"),f=e.objectStore("products"),g=0;c()},function(){self.postMessage({status:"error",msg:"Error getting products from the server"})})};